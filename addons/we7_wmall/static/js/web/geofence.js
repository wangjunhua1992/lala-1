define(["jquery"],function(a){var b={polygons:{},colors:{1:{strokeColor:"#4589ef",fillColor:"#71a3ef"},2:{strokeColor:"#1ebd4f",fillColor:"#1ecb54"},3:{strokeColor:"#06954b",fillColor:"#41ad73"},4:{strokeColor:"#9a6a38",fillColor:"#b38f66"},5:{strokeColor:"#6b543c",fillColor:"#917e6a"},6:{strokeColor:"#4589ef",fillColor:"#71a3ef"},7:{strokeColor:"#1ebd4f",fillColor:"#1ecb54"},8:{strokeColor:"#06954b",fillColor:"#41ad73"},9:{strokeColor:"#9a6a38",fillColor:"#b38f66"},10:{strokeColor:"#6b543c",fillColor:"#917e6a"}}};return b.init=function(c){if("google"==c.mapType){var d=new google.maps.Map(document.getElementById("allmap"),{center:{lat:parseFloat(c.store.location_x),lng:parseFloat(c.store.location_y)},zoom:14});c.areas&&b.length(c.areas)&&a.each(c.areas,function(a,b){var d=[];for(var e in b.path)d.push({lat:b.path[e].lat?parseFloat(b.path[e].lat):b.path[e][1],lng:b.path[e].lng?parseFloat(b.path[e].lng):b.path[e][0]});c.areas[a].path=d})}else{var d=new AMap.Map("allmap",{resizeEnable:!0,zoom:14,doubleClickZoom:!1,center:[c.store.location_y,c.store.location_x]});d.addControl(new AMap.ToolBar)}window.map=d,window.tmodtpl=c.tmodtpl,b.isChange=c.isChange,b.store=c.store,b.areas=c.areas,b.mapType=c.mapType,b.areas&&!a.isArray(b.areas)||(b.areas={}),b.areasOriginal=c.areas,b.tplArea(),b.tplEditor(),b.initDom()},b.tplArea=function(){var c=tmodtpl("tpl-area",b);a(".geofence-container").html(c)},b.markerStore=function(){if(b.store.location_y&&b.store.location_x)if("google"==b.mapType)var a=new google.maps.Marker({position:{lat:parseFloat(b.store.location_x),lng:parseFloat(b.store.location_y)},map:map,icon:{url:"../addons/we7_wmall/static/img/shop_marker.png",scaledSize:new google.maps.Size(40,55)}});else{var a=new AMap.Marker({position:[b.store.location_y,b.store.location_x],offset:new AMap.Pixel(-10,-36),content:'<div class="marker-start-head-route"></div>'});a.setMap(map)}},b.tplEditor=function(){if("google"==b.mapType){b.markerStore();for(var c in b.polygons)b.polygons[c].setVisible(!1);a.each(b.areas,function(a,c){var d=[];for(var e in c.path)d.push({lat:c.path[e].lat?parseFloat(c.path[e].lat):c.path[e][1],lng:c.path[e].lng?parseFloat(c.path[e].lng):c.path[e][0]});var f=b.colors[c.colorType],g=new google.maps.Polygon({paths:d,draggable:!1,editable:!1,fillColor:f.fillColor,fillOpacity:.8,strokeColor:f.strokeColor,strokeOpacity:.9,strokeWeight:3,visible:!0,map:map});b.polygons[a]=g,g.setMap(map)}),a(':hidden[name="areas"]').val(encodeURI(JSON.stringify(b.areas)))}else map.clearMap(),b.markerStore(),a.each(b.areas,function(a,c){var d=b.colors[c.colorType],e=new AMap.Polygon({path:c.path,strokeColor:d.strokeColor,strokeOpacity:.9,strokeWeight:3,fillColor:d.fillColor,fillOpacity:.8});b.polygons[a]=e,e.setMap(map)}),a(':hidden[name="areas"]').val(encodeURI(JSON.stringify(b.areas)))},b.initDom=function(){a(document).off("click","#area-add"),a(document).on("click","#area-add",function(){if(1==b.isActive)return!1;var a=b.getId("M",0);if(b.length(b.areas)>=10)return void Notify.info("最多可添加10个！");var c=b.getColor(),d=b.colors[c];if(b.isActive=1,b.areas[a]={delivery_price:0,delivery_free_price:0,send_price:0,strokeColor:d.strokeColor,fillColor:d.fillColor,isActive:1,isAdd:1,path:[],colorType:c},"google"==b.mapType){var e=new google.maps.drawing.DrawingManager({drawingMode:google.maps.drawing.OverlayType.POLYGON,drawingControl:!1,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:["polygon","marker","circle","polyline","rectangle"]},polygonOptions:{draggable:!1,editable:!1,fillColor:d.fillColor,fillOpacity:.4,strokeColor:d.strokeColor,strokeOpacity:1,strokeWeight:3,visible:!0,map:map}});e.setMap(map),google.maps.event.addListener(e,"polygoncomplete",function(c){e.setMap(null);for(var d=c.getPath(),f=[],g=0;g<d.getLength();g++){var h=d.getAt(g);f.push({lat:h.lat(),lng:h.lng()})}b.areas[a].path=f,c.setVisible(!1),b.tplArea(),b.tplEditor()})}else{var f=new AMap.MouseTool(map);f.polygon();AMap.event.addListener(f,"draw",function(c){f.close();var d=c.obj;new AMap.PolyEditor(map,d).open(),b.areas[a].path=d.getPath(),b.tplArea(),b.tplEditor()})}b.tplArea(),b.tplEditor()}),a(document).off("click",".area-item .editor-area-item"),a(document).on("click",".area-item .editor-area-item",function(){var c=a(this).data("id");if(!c||!b.polygons[c])return!1;b.isActive=1;var d=b.areas[c];if(d.isActive=1,d.isAdd=0,"google"==b.mapType){var e=b.polygons[c];e.setEditable(!0)}else{var e=new AMap.PolyEditor(map,b.polygons[c]);e.open()}b.tplArea()}),a(document).off("click",".area-item .btn-reset"),a(document).on("click",".area-item .btn-reset",function(){var c=a(this).data("id");Notify.confirm("退出编辑后，此次修改将不会生效，是否确定退出？",function(){b.isActive=0;var a=b.areas[c];a.isActive=0,1==a.isAdd?(delete b.areas[c],"google"==b.mapType&&(b.polygons[c].setVisible(!1),delete b.polygons[c])):(b.areas[c]=b.areasOriginal[c],"google"==b.mapType&&(b.polygons[c].setEditable(!1),b.polygons[c].setVisible(!1))),b.tplArea(),b.tplEditor()})}),a(document).off("click",".area-item .btn-delete"),a(document).on("click",".area-item .btn-delete",function(){var c=a(this).data("id");Notify.confirm("确定删除此区域吗？",function(){b.isActive=0,delete b.areas[c],"google"==b.mapType&&(b.polygons[c].setVisible(!1),delete b.polygons[c]),b.tplArea(),b.tplEditor()})}),a(document).off("click",".area-item .btn-save"),a(document).on("click",".area-item .btn-save",function(){var c=a(this).data("id");Notify.confirm("确定对该区域进行修改？",function(){var a=b.polygons[c];if("google"==b.mapType){var d=a.getPath(),e=[];if(d&&d.getLength())for(var f=0;f<d.getLength();f++){var g=d.getAt(f);e.push({lat:g.lat(),lng:g.lng()})}b.areas[c].path=e,a.setEditable(!1),a.setVisible(!1)}else b.areas[c].path=a.getPath();b.areas[c].isActive=0,b.areas[c].send_price=parseFloat(b.areas[c].send_price),b.areas[c].delivery_price=parseFloat(b.areas[c].delivery_price),b.areas[c].delivery_free_price=parseFloat(b.areas[c].delivery_free_price),b.isActive=0,b.tplArea(),b.tplEditor()})}),a(document).on("input propertychange change","#area-container .diy-bind",function(){var c=a(this),d=c.data("bind"),e=c.data("bind-child"),f=c.data("bind-parent"),g="",h=this.tagName;if("INPUT"==h){var i=c.data("placeholder");g=c.val(),g=""==g?i:g}else"SELECT"==h?g=c.find("option:selected").val():"TEXTAREA"==h&&(g=c.val());g=a.trim(g),e?f?b.areas[e][f][d]=g:b.areas[e][d]=g:b.areas[d]=g})},b.getColor=function(){var c=[1,2,3,4,5,6,7,8,9,10];for(var d in b.areas){var e=a.inArray(b.areas[d].colorType,c);-1!=e&&c.splice(e,1)}return c.shift()},b.length=function(a){if(void 0===a)return 0;var b=0;for(var c in a)b++;return b},b.getId=function(a,b){return a+(+new Date+b)},b});